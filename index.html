<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ç™»å½• - ç™¾åˆ€ä¼š</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      height: 100%;
      background: transparent;
    }

    #starfield {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: -1;
      background: black;
    }

    body {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      background: transparent;
      padding: env(safe-area-inset-top, 20px) env(safe-area-inset-right, 100px) env(safe-area-inset-bottom, 20px) env(safe-area-inset-left, 60px);
      box-sizing: border-box;
    }

    .login-container {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2), 0 0 60px rgba(135, 206, 235, 0.1);
      padding: 40px;
      width: 90%;
      max-width: 400px;
      text-align: center;
      z-index: 10;
      animation: slideUp 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      box-sizing: border-box;
    }

    .logo {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 50%;
      margin: 0 auto 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
      overflow: hidden;
      position: relative;
    }

    .logo-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }

    .logo-fallback {
      color: white;
      font-size: 32px;
      font-weight: bold;
      display: none;
    }

    h1 {
      font-size: 28px;
      color: #333;
      margin-bottom: 10px;
    }

    .subtitle {
      font-size: 16px;
      color: #666;
      margin-bottom: 40px;
    }

    .google-btn {
      width: 100%;
      padding: 16px;
      background: #4285f4;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .google-icon {
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .footer {
      margin-top: 30px;
      font-size: 13px;
      color: #aaa;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    #loading {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 20px;
      border-radius: 10px;
      z-index: 1000;
    }

    #error {
      display: none;
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 0, 0, 0.9);
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <canvas id="starfield"></canvas>
  <div id="loading">è·ƒè¿å¼•æ“å·²å¯åŠ¨ï¼<br> <br>[å‰å¾€Googleç™»å½•]</div>
  <div id="error"></div>
  <div class="login-container">
    <div class="logo">
      <img 
        src="./assets/pic/favicon.png" 
        alt="ç™¾åˆ€ä¼šLogo" 
        class="logo-img"
        onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
      />
      <div class="logo-fallback"> </div>
    </div>
    <h1>å³å°†è·ƒè¿åˆ°ç™¾åˆ€ä¼š</h1>
    <p class="subtitle">Everything Both Nothing</p>
    <button id="googleLoginBtn" class="google-btn">
      <div class="google-icon"><i class="fab fa-google" style="color: #4285f4; font-size: 12px;"></i></div>
      ç‚¹æ­¤å¯åŠ¨è·ƒè¿å¼•æ“<br>[é€šè¿‡Googleè´¦å·ä¸€é”®ç™»å½•]
    </button>
    <div class="footer">ğŸ˜æ•™ä¸»æ‚„æ‚„è¯ğŸ’¬ï½œğŸ¤‘ç®—å‘½ç”³è¯·ğŸ”®ï½œğŸ¤©å¥½ç‰©æ¨èğŸ›ï¸<br> <br>ç™»å½•å³è¡¨ç¤ºæ‚¨åŒæ„æˆ‘ä»¬çš„<br>æœåŠ¡æ¡æ¬¾å’Œéšç§æ”¿ç­–</div>
  </div>
  <script>
    const canvas = document.getElementById('starfield');
    const ctx = canvas.getContext('2d');

    let width, height, centerX, centerY;
    const numDots = 100;
    const numStreaks = 300;
    const dots = [];
    const streaks = [];

    function resize() {
      width = canvas.width = window.innerWidth;
      height = canvas.height = window.innerHeight;
      centerX = width / 2;
      centerY = height / 2;
    }

    window.addEventListener('resize', resize);
    resize();

    for (let i = 0; i < numDots; i++) {
      dots.push({
        x: Math.random() * width,
        y: Math.random() * height,
        size: Math.random() * 1.5 + 0.3,
        brightness: Math.random() * 0.5 + 0.2
      });
    }

    function createStreak() {
      const angle = Math.random() * Math.PI * 2;
      return {
        angle,
        radius: 0,
        speed: Math.random() * 3 + 2,
        length: Math.random() * 60 + 40,
        width: Math.random() * 1.2 + 0.5
      };
    }

    for (let i = 0; i < numStreaks; i++) {
      streaks.push(createStreak());
    }

    function draw() {
      ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
      ctx.fillRect(0, 0, width, height);

      for (const dot of dots) {
        ctx.beginPath();
        ctx.arc(dot.x, dot.y, dot.size, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(255,255,255,${dot.brightness})`;
        ctx.fill();
      }

      for (const star of streaks) {
        const x1 = centerX + Math.cos(star.angle) * (star.radius - star.length * 0.3);
        const y1 = centerY + Math.sin(star.angle) * (star.radius - star.length * 0.3);
        const x2 = centerX + Math.cos(star.angle) * (star.radius + star.length * 0.7);
        const y2 = centerY + Math.sin(star.angle) * (star.radius + star.length * 0.7);

        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.9)';
        ctx.lineWidth = star.width;
        ctx.stroke();

        star.radius += star.speed;

        if (x2 < 0-0.1*width || x2 > 1.1*width || y2 < 0-0.1*height || y2 > 1.1*height) {
          Object.assign(star, createStreak());
        }
      }

      requestAnimationFrame(draw);
    }

    draw();
  </script>
  <script>
    // ç¡¬ç¼–ç ç¯å¢ƒå˜é‡
    const SUPABASE_URL = 'https://pvjowkjksutkhpsomwvv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB2am93a2prc3V0a2hwc29td3Z2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc4NzYxMzEsImV4cCI6MjA2MzQ1MjEzMX0.m98BRjqAnpjVpyDxUC-9LRrU4B3SRXYdHMO3Dez-qyc';

    // éªŒè¯ç¯å¢ƒå˜é‡
    if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
        console.error('ç¯å¢ƒå˜é‡æœªæ­£ç¡®åŠ è½½:', { SUPABASE_URL, SUPABASE_ANON_KEY });
        throw new Error('ç¯å¢ƒå˜é‡æœªæ­£ç¡®åŠ è½½');
    }

    // éªŒè¯ URL æ ¼å¼
    try {
        new URL(SUPABASE_URL);
    } catch (error) {
        console.error('æ— æ•ˆçš„ SUPABASE_URL:', SUPABASE_URL);
        throw new Error('æ— æ•ˆçš„ SUPABASE_URL');
    }

    // è§’è‰²å¯¹åº”çš„é‡å®šå‘URL
    const ROLE_REDIRECTS = {
        fan: 'https://fans.baidaohui.com',
        member: 'https://fans.baidaohui.com',
        anchor: 'https://master.baidaohui.com',
        firstmate: 'https://firstmate.baidaohui.com'
    };

    // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // DOM å…ƒç´ 
    const googleLoginBtn = document.getElementById('googleLoginBtn');
    const loadingDiv = document.getElementById('loading');
    const errorDiv = document.getElementById('error');

    // å·¥å…·å‡½æ•°
    function showLoading(show = true) {
        loadingDiv.style.display = show ? 'block' : 'none';
        googleLoginBtn.disabled = show;
    }

    function showError(message) {
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => {
            errorDiv.style.display = 'none';
        }, 5000);
    }

    function hideError() {
        errorDiv.style.display = 'none';
    }

    // è·å–ç”¨æˆ·è§’è‰²
    async function getUserRole(userId) {
        try {
            // é¦–å…ˆå°è¯•ä» user_metadata è·å–è§’è‰²
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (user?.user_metadata?.role) {
                return user.user_metadata.role;
            }

            // å¦‚æœ metadata ä¸­æ²¡æœ‰è§’è‰²ï¼Œè°ƒç”¨ RPC å‡½æ•°
            const { data, error } = await supabaseClient.rpc('get_role', { uid: userId });
            
            if (error) {
                console.error('è·å–è§’è‰²å¤±è´¥:', error);
                return null;
            }
            
            return data || null;
        } catch (error) {
            console.error('è·å–è§’è‰²æ—¶å‘ç”Ÿé”™è¯¯:', error);
            return null;
        }
    }

    // æ£€æŸ¥ç”¨æˆ·æ˜µç§°
    function hasNickname(user) {
        return user?.user_metadata?.nickname || 
               user?.user_metadata?.display_name || 
               user?.user_metadata?.full_name ||
               user?.user_metadata?.name;
    }

    // å¤„ç†ç™»å½•æˆåŠŸåçš„é‡å®šå‘
    async function handleLoginSuccess(session) {
        try {
            const user = session.user;
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ˜µç§°ï¼Œå¦‚æœæ²¡æœ‰åˆ™è·³è½¬åˆ°è®¾ç½®é¡µé¢
            if (!hasNickname(user)) {
                console.log('ç”¨æˆ·æœªè®¾ç½®æ˜µç§°ï¼Œè·³è½¬åˆ°è®¾ç½®é¡µé¢');
                window.location.href = 'set-profile.html';
                return;
            }

            // è·å–ç”¨æˆ·è§’è‰²
            const role = await getUserRole(user.id);
            console.log('ç”¨æˆ·è§’è‰²:', role);

            // æ ¹æ®è§’è‰²å†³å®šé‡å®šå‘URL
            let redirectUrl;
            if (role && ROLE_REDIRECTS[role]) {
                redirectUrl = ROLE_REDIRECTS[role];
            } else {
                // é»˜è®¤é‡å®šå‘åˆ° fans é¡µé¢
                redirectUrl = ROLE_REDIRECTS.fan;
            }

            console.log('é‡å®šå‘åˆ°:', redirectUrl);
            
            // æ·»åŠ ä¸€ä¸ªçŸ­æš‚çš„å»¶è¿Ÿè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸçŠ¶æ€
            setTimeout(() => {
                window.location.href = redirectUrl;
            }, 1000);

        } catch (error) {
            console.error('å¤„ç†ç™»å½•æˆåŠŸæ—¶å‘ç”Ÿé”™è¯¯:', error);
            showError('ç™»å½•å¤„ç†å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            showLoading(false);
        }
    }

    // Google OAuth ç™»å½•
    async function signInWithGoogle() {
        try {
            hideError();
            showLoading(true);

            console.log('å¼€å§‹ Google ç™»å½•...');
            
            const { data, error } = await supabaseClient.auth.signInWithOAuth({
                provider: 'google',
                options: {
                    redirectTo: window.location.origin + window.location.pathname,
                    queryParams: {
                        access_type: 'offline',
                        prompt: 'consent',
                    }
                }
            });

            if (error) {
                throw error;
            }

            // OAuth ç™»å½•ä¼šè§¦å‘é¡µé¢é‡å®šå‘ï¼Œè¿™é‡Œä¸éœ€è¦é¢å¤–å¤„ç†
            console.log('Google ç™»å½•è¯·æ±‚å·²å‘é€');

        } catch (error) {
            console.error('Google ç™»å½•å¤±è´¥:', error);
            showError('ç™»å½•å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
            showLoading(false);
        }
    }

    // æ£€æŸ¥å½“å‰ä¼šè¯çŠ¶æ€
    async function checkSession() {
        try {
            const { data: { session }, error } = await supabaseClient.auth.getSession();
            
            if (error) {
                console.error('æ£€æŸ¥ä¼šè¯å¤±è´¥:', error);
                return;
            }

            if (session) {
                console.log('å‘ç°ç°æœ‰ä¼šè¯ï¼Œå¤„ç†ç™»å½•');
                showLoading(true);
                await handleLoginSuccess(session);
            }
        } catch (error) {
            console.error('æ£€æŸ¥ä¼šè¯æ—¶å‘ç”Ÿé”™è¯¯:', error);
        }
    }

    // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
    supabaseClient.auth.onAuthStateChange(async (event, session) => {
        console.log('è®¤è¯çŠ¶æ€å˜åŒ–:', event, session?.user?.email);
        
        if (event === 'SIGNED_IN' && session) {
            await handleLoginSuccess(session);
        } else if (event === 'SIGNED_OUT') {
            showLoading(false);
            console.log('ç”¨æˆ·å·²ç™»å‡º');
        } else if (event === 'TOKEN_REFRESHED') {
            console.log('ä»¤ç‰Œå·²åˆ·æ–°');
        }
    });

    // äº‹ä»¶ç›‘å¬å™¨
    googleLoginBtn.addEventListener('click', signInWithGoogle);

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç°æœ‰ä¼šè¯
    document.addEventListener('DOMContentLoaded', () => {
        console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œæ£€æŸ¥ä¼šè¯çŠ¶æ€');
        checkSession();
    });

    // å¤„ç†é¡µé¢å¯è§æ€§å˜åŒ–ï¼ˆå½“ç”¨æˆ·ä»OAuthé¡µé¢è¿”å›æ—¶ï¼‰
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
            console.log('é¡µé¢å˜ä¸ºå¯è§ï¼Œæ£€æŸ¥ä¼šè¯çŠ¶æ€');
            setTimeout(checkSession, 500); // ç»™ä¸€äº›æ—¶é—´è®©è®¤è¯çŠ¶æ€æ›´æ–°
        }
    });

    // é”™è¯¯å¤„ç†
    window.addEventListener('error', (event) => {
        console.error('å…¨å±€é”™è¯¯:', event.error);
        showError('å‘ç”Ÿæœªé¢„æœŸçš„é”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        showLoading(false);
    });

    // æœªå¤„ç†çš„Promiseæ‹’ç»
    window.addEventListener('unhandledrejection', (event) => {
        console.error('æœªå¤„ç†çš„Promiseæ‹’ç»:', event.reason);
        showError('å‘ç”Ÿç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
        showLoading(false);
    });
  </script>
</body>
</html>