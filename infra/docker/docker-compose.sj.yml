version: '3.8'

services:
  # Nginx 反向代理
  nginx:
    image: nginx:alpine
    container_name: baidaohui-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/ssl/certs
      - ./ssl:/etc/ssl/private
      - prestashop_data:/var/www/html
    depends_on:
      - chat-api
      - prestashop
      - prosody
    networks:
      - baidaohui-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 30M

  # Redis 缓存
  redis:
    image: redis:7-alpine
    container_name: baidaohui-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --maxmemory 50mb --maxmemory-policy allkeys-lru
    networks:
      - baidaohui-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 50M

  # 聊天API服务 (Flask + Gunicorn)
  chat-api:
    build:
      context: ../../apps/api/chat
      dockerfile: Dockerfile
    container_name: baidaohui-chat-api
    ports:
      - "5003:5003"
    environment:
      - FLASK_ENV=production
      - PORT=5003
      - MONGO_URL=${MONGO_URL}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - REDIS_URL=redis://redis:6379/0
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      - redis
    networks:
      - baidaohui-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 150M

  # Auth API服务
  auth-api:
    build:
      context: ../../apps/api/auth
      dockerfile: Dockerfile
    container_name: baidaohui-auth-api
    ports:
      - "5001:5001"
    environment:
      - FLASK_ENV=production
      - PORT=5001
      - MONGO_URL=${MONGO_URL}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - REDIS_URL=redis://redis:6379/0
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      - redis
    networks:
      - baidaohui-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 200M

  # Profile API服务
  profile-api:
    build:
      context: ../../apps/api/profile
      dockerfile: Dockerfile
    container_name: baidaohui-profile-api
    ports:
      - "5002:5002"
    environment:
      - FLASK_ENV=production
      - PORT=5002
      - MONGO_URL=${MONGO_URL}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - redis
    networks:
      - baidaohui-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 200M

  # SSO API服务
  sso-api:
    build:
      context: ../../apps/api/sso
      dockerfile: Dockerfile
    container_name: baidaohui-sso-api
    ports:
      - "5004:5004"
    environment:
      - FLASK_ENV=production
      - PORT=5004
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - REDIS_URL=redis://redis:6379/0
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - PRESTASHOP_API_URL=http://prestashop/api
      - PRESTASHOP_API_KEY=${PRESTASHOP_API_KEY}
    depends_on:
      - redis
      - prestashop
    networks:
      - baidaohui-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 200M

  # Shop Webhooks API服务
  shop-api:
    build:
      context: ../../apps/api/shop
      dockerfile: Dockerfile
    container_name: baidaohui-shop-api
    ports:
      - "5005:5005"
    environment:
      - FLASK_ENV=production
      - PORT=5005
      - MONGO_URL=${MONGO_URL}
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - S3_ENDPOINT=${S3_ENDPOINT}
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - redis
      - prestashop
    networks:
      - baidaohui-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 200M

  # Prosody XMPP服务器
  prosody:
    image: prosody/prosody:latest
    container_name: baidaohui-prosody
    ports:
      - "5222:5222"  # XMPP客户端连接
      - "5269:5269"  # XMPP服务器间连接
      - "5280:5280"  # HTTP模块
    volumes:
      - ./prosody/prosody.cfg.lua:/etc/prosody/prosody.cfg.lua
      - prosody_data:/var/lib/prosody
    networks:
      - baidaohui-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 30M

  # PrestaShop 电商平台
  prestashop:
    image: prestashop/prestashop:8.1
    container_name: baidaohui-prestashop
    ports:
      - "8080:80"
    environment:
      - DB_SERVER=prestashop-db
      - DB_NAME=prestashop
      - DB_USER=prestashop
      - DB_PASSWD=prestashop_password
      - PS_DOMAIN=buyer.shop.baidaohui.com
      - PS_FOLDER_ADMIN=admin
      - PS_INSTALL_AUTO=1
      - PS_ERASE_DB=1
      - PS_INSTALL_DB=1
      - PS_DEV_MODE=0
      - PS_ENABLE_SSL=0
    volumes:
      - prestashop_data:/var/www/html
      - ../../apps/ecommerce/modules:/var/www/html/modules/custom
      - ../../apps/ecommerce/webhooks:/var/www/html/webhooks
    command: >
      bash -c "
        chown -R www-data:www-data /var/www/html/modules/custom &&
        chown -R www-data:www-data /var/www/html/webhooks &&
        chmod -R 755 /var/www/html/modules/custom &&
        chmod -R 755 /var/www/html/webhooks &&
        exec docker-php-entrypoint apache2-foreground
      "
    depends_on:
      - prestashop-db
    networks:
      - baidaohui-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M

  # PrestaShop 数据库
  prestashop-db:
    image: mysql:8.0
    container_name: baidaohui-prestashop-db
    ports:
      - "3306:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=root_password
      - MYSQL_DATABASE=prestashop
      - MYSQL_USER=prestashop
      - MYSQL_PASSWORD=prestashop_password
    volumes:
      - prestashop_db_data:/var/lib/mysql
    networks:
      - baidaohui-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M



  # Supervisor 进程管理
  supervisor:
    build:
      context: ./supervisor
      dockerfile: Dockerfile
    container_name: baidaohui-supervisor
    ports:
      - "9001:9001"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - baidaohui-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 50M



networks:
  baidaohui-network:
    driver: bridge

volumes:
  redis_data:
  prosody_data:
  prestashop_data:
  prestashop_db_data: 