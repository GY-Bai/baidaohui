# Nginx API配置文件
# VPS后端服务反向代理配置

server {
    listen 80;
    server_name api.baidaohui.com 107.172.87.113;
    
    # 基本安全头
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy strict-origin-when-cross-origin always;
    
    # CORS配置 - 允许前端域名访问
    add_header Access-Control-Allow-Origin "https://baidaohui.com" always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
    add_header Access-Control-Allow-Credentials true always;
    
    # 处理预检请求
    if ($request_method = OPTIONS) {
        return 204;
    }
    
    # 认证服务 (端口 5001)
    location /api/auth/ {
        proxy_pass http://auth-service:5001/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 10s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
    # SSO服务 (端口 5002)
    location /api/sso/ {
        proxy_pass http://sso-service:5002/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 10s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
    # 聊天服务 (端口 5003)
    location /api/chat/ {
        proxy_pass http://chat-service:5003/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 10s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        
        # WebSocket支持
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    
    # 电商API服务 (端口 5004)
    location /api/ecommerce/ {
        proxy_pass http://ecommerce-service:5004/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 10s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
    # 邀请服务 (端口 5006)
    location /api/invite/ {
        proxy_pass http://invite-service:5006/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 10s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
    # 支付服务 (端口 5008)
    location /api/payment/ {
        proxy_pass http://payment-service:5008/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 10s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
    # 密钥服务 (端口 5009)
    location /api/keys/ {
        proxy_pass http://key-service:5009/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 10s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
    # 静态API服务 (端口 5010)
    location /api/static/ {
        proxy_pass http://static-api-service:5010/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 10s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
    # 算命服务 (水牛城VPS - 端口 5007)
    location /api/fortune/ {
        proxy_pass http://216.144.233.104:5007/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 10s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
    # 邮件服务 (水牛城VPS - 端口 5008)
    location /api/email/ {
        proxy_pass http://216.144.233.104:5008/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 10s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
    # 健康检查端点
    location /api/health {
        access_log off;
        return 200 '{"status":"ok","timestamp":"$time_iso8601","server":"$hostname","vps":"107.172.87.113"}';
        add_header Content-Type application/json always;
    }
    
    # 系统状态接口
    location /api/status {
        access_log off;
        return 200 '{"status":"running","services":"backend-api","location":"san-jose","timestamp":"$time_iso8601"}';
        add_header Content-Type application/json always;
    }
    
    # 404处理
    location / {
        return 404 '{"error":"API endpoint not found","available_paths":["/api/auth/","/api/sso/","/api/invite/","/api/fortune/","/api/chat/","/api/ecommerce/","/api/payment/","/api/keys/","/api/static/","/api/email/"],"timestamp":"$time_iso8601"}';
        add_header Content-Type application/json always;
    }
    
    # 错误页面
    error_page 502 503 504 /50x.json;
    location = /50x.json {
        return 502 '{"error":"Backend service unavailable","message":"One or more backend services are down","timestamp":"$time_iso8601"}';
        add_header Content-Type application/json always;
    }
    
    # 访问日志配置
    access_log /var/log/nginx/api_access.log combined;
    error_log /var/log/nginx/api_error.log warn;
} 